<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StructureScan AI - Professional Demo</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a2332 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            flex-grow: 1;
            text-align: center;
        }

        .header h1 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .header .subtitle { opacity: 0.9; font-size: 0.95rem; }
        .company-tag {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.75rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            border-top: 3px solid var(--primary);
        }

        .stat-label { color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; margin-bottom: 0.75rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-trend { font-size: 0.875rem; color: var(--success); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: all 0.3s;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .action-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
            border-color: var(--primary);
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .sample-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sample-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .sample-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .sample-info { padding: 1.25rem; }
        .sample-title { font-weight: 600; margin-bottom: 0.5rem; }
        .sample-desc { font-size: 0.875rem; color: var(--text-secondary); }

        .camera-view {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin: 2rem 0;
            border: 2px solid var(--border);
        }

        .camera-preview {
            width: 100%;
            height: auto;
            display: block;
            max-height: 600px;
            object-fit: contain;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .detection-box {
            position: absolute;
            border: 3px solid;
            border-radius: 8px;
            animation: boxAppear 0.5s ease-out;
        }

        @keyframes boxAppear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .detection-box.high { border-color: var(--danger); box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); }
        .detection-box.medium { border-color: var(--warning); box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); }

        .detection-label {
            position: absolute;
            top: -32px;
            left: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            animation: labelSlide 0.3s ease-out 0.3s both;
        }

        @keyframes labelSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .camera-controls {
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            justify-content: center;
        }

        .analysis-status {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(37, 99, 235, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s;
        }

        .status-text { color: var(--text-secondary); margin-top: 1rem; }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .summary-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .summary-card.confidence { border-left: 3px solid var(--primary); }
        .summary-card.issues { border-left: 3px solid var(--danger); }
        .summary-card.cost { border-left: 3px solid var(--warning); }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .summary-value { font-size: 2.25rem; font-weight: 700; line-height: 1; }

        .issues-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin: 2rem 0;
        }

        .issues-header {
            background: rgba(37, 99, 235, 0.1);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .issue-item { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .issue-item:last-child { border-bottom: none; }

        .issue-header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .issue-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem; }
        .issue-location { color: var(--text-secondary); font-size: 0.875rem; }

        .severity-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .severity-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .issue-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .meta-label { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .meta-value { font-weight: 600; }

        .hidden { display: none !important; }
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: modalAppear 0.3s ease-out;
}

@keyframes modalAppear {
    from { opacity: 0; transform: scale(0.9) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.5rem;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input {
    width: 100%;
    background: var(--bg-dark);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--text-primary);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

textarea.form-input {
    resize: vertical;
    min-height: 80px;
}
.menu-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s;
}

.menu-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.menu-btn svg {
    width: 28px;
    height: 28px;
    stroke: var(--text-primary);
    stroke-width: 2.5;
}

.side-menu {
    position: fixed;
    top: 0;
    left: -300px;
    width: 300px;
    height: 100%;
    background: var(--bg-dark);
    box-shadow: 4px 0 15px rgba(0,0,0,0.3);
    z-index: 1001;
    transition: left 0.3s ease;
    display: flex;
    flex-direction: column;
}

.side-menu.open {
    left: 0;
}

.menu-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.menu-header h2 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.menu-header p {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.menu-nav {
    flex-grow: 1;
    list-style: none;
    padding: 1rem 0;
}

.menu-nav a {
    display: block;
    color: var(--text-primary);
    text-decoration: none;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.menu-nav a:hover, .menu-nav a.active {
    background: rgba(37, 99, 235, 0.1);
    border-left-color: var(--primary);
    color: var(--primary);
}

.menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

.menu-overlay.open {
    opacity: 1;
    visibility: visible;
}


        @media (max-width: 768px) {
            .stats-grid, .sample-grid, .results-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <h2>StructureScan AI</h2>
            <p>Menu</p>
        </div>
        <nav class="menu-nav">
            <a href="#" onclick="showDashboardView()">Dashboard</a>
            <a href="#" onclick="showProjectsView()">Projects</a>
            <a href="#" onclick="showSettingsView()">Settings</a>
        </nav>
    </div>
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <div class="header">
        <button class="menu-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <div class="header-content">
            <h1>StructureScan AI</h1>
        </div>
        <div style="width: 44px;"></div> <!-- Spacer -->
    </div>

    <div class="container">
        <!-- Dashboard -->
        <div id="dashboardView">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Scans</div>
                    <div class="stat-value">47</div>
                    <div class="stat-trend">↑ 12% this month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Issues Detected</div>
                    <div class="stat-value">12</div>
                    <div class="stat-trend">3 high priority</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Savings</div>
                    <div class="stat-value">$8.4K</div>
                    <div class="stat-trend">Early detection value</div>
                </div>
            </div>

            <div class="action-card" onclick="openProjectModal()">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 20px; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 40px; height: 40px; stroke: white; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </div>
                <h2>Start Structural Analysis</h2>
                <p>Capture images to detect structural issues, water damage, and estimate repair costs using AI-powered analysis.</p>
                <button class="btn-primary" style="margin-top: 1.5rem;">Begin Scan</button>
            </div>
        </div>

        <!-- Sample Selection -->
        <div id="sampleView" class="hidden">
            <button class="btn-secondary" onclick="showDashboard()">← Back</button>
            <h2 style="margin: 2rem 0 1rem; font-size: 1.75rem;">Select Sample to Analyze</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Choose a structural issue to see AI detection in action</p>
            
            <div class="sample-grid">
                <div class="sample-card" onclick="selectSample('water')">
                    <img src='https://i.imgur.com/sVkNhey.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Water Damage">
                    <div class="sample-info">
                        <div class="sample-title">Water Damage - Wall</div>
                        <div class="sample-desc">Visible water staining with potential mold growth</div>
                    </div>
                </div>
                <div class="sample-card" onclick="selectSample('crack')">
                    <img src='https://i.imgur.com/AnkAyMC.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Wall Crack">
                    <div class="sample-info">
                        <div class="sample-title">Structural Crack - Wall</div>
                        <div class="sample-desc">Vertical crack indicating settlement issues</div>
                    </div>
                </div>
                <div class="sample-card" onclick="selectSample('corrosion')">
                    <img src='https://i.imgur.com/6jrvabV.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Pipe Corrosion">
                    <div class="sample-info">
                        <div class="sample-title">Pipe Corrosion</div>
                        <div class="sample-desc">Metal corrosion on exposed plumbing</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera/Analysis -->
        <div id="cameraView" class="hidden">
            <button class="btn-secondary" onclick="showSamples()">← Back</button>
            
            <div class="camera-view">
                <img id="previewImage" class="camera-preview" alt="Preview">
                <div class="camera-overlay" id="detectionOverlay"></div>
                <div class="camera-controls">
                    <button class="btn-primary" id="analyzeBtn" onclick="runAnalysis()">Analyze Image</button>
                </div>
            </div>

            <div id="analysisStatus" class="analysis-status hidden">
                <h3>AI Analysis in Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="status-text" id="statusText">Initializing detection algorithms...</div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsView" class="hidden">
            <button class="btn-secondary" onclick="showDashboard()">← Start New Scan</button>
            
            <h2 style="font-size: 2rem; margin: 2rem 0 0.5rem;">Analysis Complete</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Scan completed • <span id="timestamp"></span></p>

            <div class="camera-view">
                <img id="resultImage" class="camera-preview" alt="Result">
                <div class="camera-overlay" id="resultOverlay"></div>
            </div>

            <div class="results-summary">
                <div class="summary-card confidence">
                    <div class="summary-label">AI Confidence</div>
                    <div class="summary-value" style="color: var(--primary);" id="confidenceValue">91%</div>
                </div>
                <div class="summary-card issues">
                    <div class="summary-label">Issues Found</div>
                    <div class="summary-value" style="color: var(--danger);" id="issuesCount">1</div>
                </div>
                <div class="summary-card cost">
                    <div class="summary-label">Est. Repair Cost</div>
                    <div class="summary-value" style="color: var(--warning); font-size: 1.75rem;" id="costValue">$2.4K-3.8K</div>
                </div>
            </div>

            <div class="issues-container">
                <div class="issues-header">
                    <h3>Detected Issues</h3>
                </div>
                <div id="issuesList"></div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                <button class="btn-primary" onclick="exportPDF()">Export Full Report</button>
                <button class="btn-primary">Schedule Repairs</button>
            </div>
        </div>

        <!-- Projects View -->
        <div id="projectsView" class="hidden">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">Projects</h2>
            <div id="projectList" class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                 <!-- Projects will be dynamically inserted here -->
                <div class="stat-card" style="cursor: pointer;" onclick="alert('Navigate to project details')">
                    <div class="stat-label">123 Main Street</div>
                    <div class="stat-value" style="font-size: 1.5rem;">3 Scans</div>
                    <div class="stat-trend">Last scan: 11/08/2025</div>
                </div>
                 <div class="stat-card" style="cursor: pointer;" onclick="alert('Navigate to project details')">
                    <div class="stat-label">Downtown Pipe Inspection</div>
                    <div class="stat-value" style="font-size: 1.5rem;">1 Scan</div>
                    <div class="stat-trend">Last scan: 11/05/2025</div>
                </div>
                <div class="action-card" onclick="openProjectModal()">
                     <h3 style="margin-bottom: 1rem;">Create New Project</h3>
                    <p>Start a new scan and save it as a new project.</p>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="hidden">
            <h2 style="font-size: 2rem; margin-bottom: 2rem;">Settings</h2>
            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="companyName" placeholder="e.g., Restoration Experts Inc" class="form-input">
            </div>
            <div class="form-group">
                <label>Company Address</label>
                <input type="text" id="companyAddress" placeholder="e.g., 123 Main St, Fort Wayne, IN" class="form-input">
            </div>
            <div class="form-group">
                <label>Contact Info</label>
                <input type="text" id="contactInfo" placeholder="e.g., John Smith (555) 123-4567" class="form-input">
            </div>
            <button class="btn-primary" onclick="saveSettings()" style="margin-right: 1rem;">Save Settings</button>
            <button class="btn-secondary" onclick="requestNotificationPermission()">Enable Notifications</button>
        </div>

        <!-- Project Detail View -->
        <div id="projectDetailView" class="hidden">
            <button class="btn-secondary" onclick="showProjectsView()">← Back to Projects</button>
            <div id="projectDetailHeader" style="margin: 2rem 0;">
                <!-- Project details will be injected here -->
            </div>
            <div id="projectScansList" class="sample-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                <!-- Scans will be injected here -->
            </div>
        </div>
    </div>
<!-- Project Setup Modal -->
<div id="projectModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Scan</h2>
            <button class="modal-close" onclick="closeProjectModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" placeholder="e.g., 123 Main Street Inspection" class="form-input">
            </div>
            <div class="form-group">
                <label for="propertyAddress">Property Address (Optional)</label>
                <input type="text" id="propertyAddress" placeholder="e.g., 123 Main St, Fort Wayne, IN" class="form-input">
            </div>
            <div class="form-group">
                <label for="clientName">Client Name (Optional)</label>
                <input type="text" id="clientName" placeholder="e.g., John Smith" class="form-input">
            </div>
            <div class="form-group">
                <label for="scanNotes">Notes (Optional)</label>
                <textarea id="scanNotes" placeholder="Add any relevant notes..." class="form-input" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeProjectModal()">Cancel</button>
            <button class="btn-primary" onclick="saveProjectAndContinue()">Continue to Scan</button>
        </div>
    </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
       // =======================================================
// === GLOBAL VARIABLES & MOCK DATA (PWA) ===
// =======================================================
    const samples = {
        // --- Samples Data (Your structural scan mock data) ---
        water: {
            image: 'https://i.imgur.com/sVkNhey.jpg',
            confidence: 94,
            issue: {
                type: 'Water Damage & Mold Growth',
                location: 'Baseboard - Lower Wall Section',
                severity: 'high',
                desc: 'Active water intrusion with visible mold growth and paint deterioration. Dark staining indicates prolonged moisture exposure. Immediate remediation required to prevent health hazards and structural damage.',
                confidence: 94,
                cost: '$2,400-$3,800',
                urgency: '7-14 days',
                box: { top: '40%', left: '20%', width: '35%', height: '30%' }
            }
        },
        corrosion: {
            image: 'https://i.imgur.com/6jrvabV.jpg',
            confidence: 96,
            issue: {
                type: 'Severe Pipe Corrosion',
                location: 'Exposed Plumbing Lines - Basement',
                severity: 'high',
                desc: 'Advanced corrosion with heavy rust buildup and material degradation. Multiple connection points compromised. Critical failure risk - pipe replacement urgent to prevent catastrophic water damage and flooding.',
                confidence: 96,
                cost: '$1,800-$3,200',
                urgency: '7-21 days',
                box: { top: '35%', left: '30%', width: '40%', height: '35%' }
            }
        },
        crack: {
            image: 'https://i.imgur.com/AnkAyMC.jpg',
            confidence: 89,
            issue: {
                type: 'Structural Crack Pattern',
                location: 'Interior Wall - Main Structure',
                severity: 'medium',
                desc: 'Multiple stress cracks detected across wall surface. Pattern indicates structural settlement or foundation movement. Significant cracking visible throughout. Monitoring and repair recommended to prevent progression.',
                confidence: 89,
                cost: '$1,200-$2,400',
                urgency: '30-60 days',
                box: { top: '15%', left: '20%', width: '60%', height: '70%' }
            }
        }
    };
    
    // --- Global Tracking Variables ---
    let currentSample = null;
    let currentProject = null;
    let currentLeadId = null;
    let currentExhId = null;
    let mockScansRemaining = 25; // Define the starting cap for the demo
    window.selectedSampleKey = null; // Stores the key of the selected sample

    const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE'; 
    const BACKEND_URL = 'YOUR_SECURE_BACKEND_URL'; // Placeholder for live server

    const allViews = ['dashboardView', 'sampleView', 'cameraView', 'resultsView', 'projectsView', 'settingsView', 'projectDetailView'];

    // =======================================================
    // === PWA CORE FUNCTIONS (VIEW & DATA MANAGEMENT) ===
    // =======================================================

    // Utility Function to get URL Parameters (Phase 1.3)
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }
    
    // --- View Management Functions (Keep your original UI logic) ---
    function toggleMenu() {
        document.getElementById('sideMenu').classList.toggle('open');
        document.getElementById('menuOverlay').classList.toggle('open');
    }

    function showView(viewId) {
        allViews.forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(viewId).classList.remove('hidden');
        document.getElementById('sideMenu').classList.remove('open');
        document.getElementById('menuOverlay').classList.remove('open');
    }

    function showDashboardView() { showView('dashboardView'); }
    function showProjectsView() {
        // Stubs for rendering projects
        // renderProjectList();
        showView('projectsView');
    }
    function showSettingsView() { showView('settingsView'); }

    function showDashboard() {
        allViews.forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('dashboardView').classList.remove('hidden');
    }
    
    // --- Project/Settings Management Stubs (from your original code) ---
    function getProjects() { return JSON.parse(localStorage.getItem('struc_projects') || '[]'); }
    function saveProjects(projects) { localStorage.setItem('struc_projects', JSON.stringify(projects)); }
    function saveScanToProject(projectId, scanData) { 
        // Implement real project saving logic here
    }
    function openProjectModal() { 
        document.getElementById('projectModal').classList.remove('hidden');
    }
    function closeProjectModal() { 
        document.getElementById('projectModal').classList.add('hidden');
        // Clear form fields
    }
    function saveProjectAndContinue() { 
        // Simplified flow: assume project saved
        currentProject = { id: 'test_proj', name: 'Test Project' }; // Mock project context
        closeProjectModal();
        showSamples();
    }
    function startNewScanForCurrentProject() { 
        if (!currentProject) { alert("No project selected!"); return; }
        showSamples();
    }
    function saveSettings() { 
        // Implement real settings saving logic here
        alert('Settings saved! (Mock)'); showDashboardView(); 
    }
    function loadSettings() { /* ... (settings loading logic omitted for brevity) ... */ }
    function requestNotificationPermission() {
        alert('Notifications enabled! (Mock)');
    }
    
    // --- Sample Selection ---
    function showSamples() {
        document.getElementById('dashboardView').classList.add('hidden');
        document.getElementById('sampleView').classList.remove('hidden');
        document.getElementById('cameraView').classList.add('hidden');
        document.getElementById('resultsView').classList.add('hidden');
    }

    function selectSample(type) {
        currentSample = samples[type];
        window.selectedSampleKey = type; // **CRITICAL: SETS THE KEY FOR ANALYSIS**
        
        document.getElementById('sampleView').classList.add('hidden');
        document.getElementById('cameraView').classList.remove('hidden');
        document.getElementById('previewImage').src = currentSample.image;
        document.getElementById('detectionOverlay').innerHTML = '';
        document.getElementById('analysisStatus').classList.add('hidden');
        document.getElementById('analyzeBtn').disabled = false;
    }
    
    // --- PWA Helper Functions (Necessary for Analysis) ---
    function captureImageAsBase64() {
        if (currentSample && currentSample.image) {
            return currentSample.image; 
        }
        return null; 
    }

    function showDetectionBox() {
        const overlay = document.getElementById('detectionOverlay');
        const issue = currentSample.issue;
        
        const box = document.createElement('div');
        box.className = `detection-box ${issue.severity}`;
        box.style.top = issue.box.top;
        box.style.left = issue.box.left;
        box.style.width = issue.box.width;
        box.style.height = issue.box.height;
        
        const label = document.createElement('div');
        label.className = 'detection-label';
        label.textContent = issue.type + ' Detected';
        label.style.color = issue.severity === 'high' ? '#fca5a5' : '#fcd34d';
        box.appendChild(label);
        
        overlay.appendChild(box);
    }
    
    function showResults() {
        document.getElementById('cameraView').classList.add('hidden');
        document.getElementById('resultsView').classList.remove('hidden');
        
        const issue = currentSample.issue;
        const scanDate = new Date();
        
        document.getElementById('timestamp').textContent = scanDate.toLocaleString();
        
        // Add project info to results if exists (stubbed out for simplicity)
        // if (currentProject && currentProject.name) { ... } 
        
        document.getElementById('resultImage').src = currentSample.image;
        document.getElementById('confidenceValue').textContent = currentSample.confidence + '%';
        document.getElementById('issuesCount').textContent = '1';
        document.getElementById('costValue').textContent = issue.cost;
        
        const resultOverlay = document.getElementById('resultOverlay');
        resultOverlay.innerHTML = '';
        const box = document.createElement('div');
        box.className = `detection-box ${issue.severity}`;
        box.style.top = issue.box.top;
        box.style.left = issue.box.left;
        box.style.width = issue.box.width;
        box.style.height = issue.box.height;
        resultOverlay.appendChild(box);
        
        // Populate issues list (simplified)
        document.getElementById('issuesList').innerHTML = `
            <div class="issue-item">
                <div class="issue-header-row">
                    <div>
                        <div class="issue-title">${issue.type}</div>
                        <div class="issue-location">${issue.location}</div>
                    </div>
                    <div class="severity-badge severity-${issue.severity}">${issue.severity.toUpperCase()}</div>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">${issue.desc}</p>
            </div>
        `;
        
        window.scrollTo(0, 0);
    }
    // NOTE: The original exportPDF logic and other project functions are assumed to be complex 
    // and omitted here for the simple fix, but should be integrated fully in your final file.


    // --- AI ANALYSIS CORE LOGIC (Restored Working Mock) ---

    function animateProgressBar() {
        document.getElementById('progressBar').style.width = '0%';
        let progress = 0;
        let statusIndex = 0;
        const statuses = [
            'Initializing AI detection...', 'Analyzing image structure...', 
            'Detecting anomalies...', 'Measuring damage severity...', 
            'Calculating repair costs...', 'Finalizing analysis...'
        ];
        
        return new Promise(resolve => {
            const interval = setInterval(() => {
                progress += 5; 
                document.getElementById('progressBar').style.width = progress + '%';
                
                if (progress % 17 < 5 && statusIndex < statuses.length) {
                    document.getElementById('statusText').textContent = statuses[statusIndex];
                    statusIndex++;
                }
                
                if (progress >= 100) {
                    clearInterval(interval);
                    resolve();
                }
            }, 60);
        });
    }

    // --- RESTORED WORKING MOCK: executeMeteredAnalysis (Uses local counter) ---
    async function executeMeteredAnalysis(leadId) {
        console.log(`[Server Sim] Requesting metered analysis for ${leadId}...`);
        
        // 1. SIMULATED USAGE CHECK 
        if (mockScansRemaining <= 0) { 
             console.log(`[Server Sim] Usage cap reached for ${leadId}. Scans remaining: 0`);
             return { success: false, message: 'USAGE_CAP_REACHED' };
        }
        
        // 2. SIMULATED DEDUCTION
        mockScansRemaining -= 1; 
        console.log(`[Server Sim] Scan successful. New scans remaining: ${mockScansRemaining}`);

        // Return the exact sample data selected by the user
        const selectedKey = window.selectedSampleKey;

        // Simulate network latency
        await new Promise(r => setTimeout(r, 1000));
        
        return { 
            success: true, 
            data: samples[selectedKey] // Returns the selected sample data
        };
    }

    // --- The primary function called by the Analyze button ---
    async function runAnalysis() {
        if (!currentLeadId || !window.selectedSampleKey) { 
           // EMERGENCY FIX: Ensure a sample is always loaded for the demo to run
        if (!window.selectedSampleKey) {
            currentSample = samples['water']; // Forces the default sample
            window.selectedSampleKey = 'water';
        }
        
        // If the lead ID is missing, we must fail
        if (!currentLeadId) {
            alert("Tracking Error: Please ensure you launch the app with a tracking ID and select a sample image.");
            return;
        }
    }

        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('analysisStatus').classList.remove('hidden');

        // Execute Metered Analysis (calls the working mock logic)
        const analysisResult = await executeMeteredAnalysis(currentLeadId); 

        // 3. Handle Results
        if (analysisResult.success) {
            currentSample = analysisResult.data; 
            await animateProgressBar(); 
            showResults();
        } else if (analysisResult.message === 'USAGE_CAP_REACHED') {
            alert("Scan failed: You have reached your pre-paid scan limit. Please contact the exhibitor for a renewal token.");
            document.getElementById('analysisStatus').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = false;
        } else {
            alert(`Analysis failed: ${analysisResult.message}`);
            document.getElementById('analysisStatus').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = false;
        }
    }


    // --- CORE FUNCTION: Initializes Tracking (Phase 1.3) ---
    function initializeLeadTracking() {
        const urlLeadId = getUrlParameter('leadId');
        const urlExhId = getUrlParameter('exhId');
        const storedLeadId = localStorage.getItem('afferio_leadId');
        const storedExhId = localStorage.getItem('afferio_exhId');

        if (urlLeadId && urlExhId) {
            currentLeadId = urlLeadId;
            currentExhId = urlExhId;
            localStorage.setItem('afferio_leadId', currentLeadId);
            localStorage.setItem('afferio_exhId', currentExhId);
            console.log(`[AfferioIQ] New Session Started. Lead ID: ${currentLeadId}`);
            // notifyServerOfFirstActivation(currentLeadId, currentExhId); // Stubs for server interaction

        } else if (storedLeadId && storedExhId) {
            currentLeadId = storedLeadId;
            currentExhId = storedExhId;
            console.log(`[AfferioIQ] Returning User Session. Lead ID: ${currentLeadId}`);
            
        } else {
            console.warn("[AfferioIQ] Tracking Failed: No Lead ID found. Functionality limited.");
        }
    }

    // --- PWA Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('Service Worker registered.');
                    initializeLeadTracking(); 
                })
                .catch(error => console.error('Service Worker registration failed:', error));
        } else {
            initializeLeadTracking(); 
        }
        // Load your initial project settings if they exist
        loadSettings(); 
    });
