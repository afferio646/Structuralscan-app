<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StructureScan AI - Professional Demo</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #334155;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a2332 100%);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            flex-grow: 1;
            text-align: center;
        }

        .header h1 { font-size: 1.5rem; font-weight: 700; margin: 0; }
        .header .subtitle { opacity: 0.9; font-size: 0.95rem; }
        .company-tag {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 1rem;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: var(--bg-card);
            padding: 1.75rem;
            border-radius: 16px;
            border: 1px solid var(--border);
            border-top: 3px solid var(--primary);
        }

        .stat-label { color: var(--text-secondary); font-size: 0.875rem; text-transform: uppercase; margin-bottom: 0.75rem; }
        .stat-value { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-trend { font-size: 0.875rem; color: var(--success); }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            transition: all 0.3s;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(37, 99, 235, 0.4); }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .action-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 2.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(37, 99, 235, 0.2);
            border-color: var(--primary);
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .sample-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .sample-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.3);
        }

        .sample-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #1a1a1a;
        }

        .sample-info { padding: 1.25rem; }
        .sample-title { font-weight: 600; margin-bottom: 0.5rem; }
        .sample-desc { font-size: 0.875rem; color: var(--text-secondary); }

        .camera-view {
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            margin: 2rem 0;
            border: 2px solid var(--border);
        }

        .camera-preview {
            width: 100%;
            height: auto;
            display: block;
            max-height: 600px;
            object-fit: contain;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .detection-box {
            position: absolute;
            border: 3px solid;
            border-radius: 8px;
            animation: boxAppear 0.5s ease-out;
        }

        @keyframes boxAppear {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .detection-box.high { border-color: var(--danger); box-shadow: 0 0 20px rgba(239, 68, 68, 0.6); }
        .detection-box.medium { border-color: var(--warning); box-shadow: 0 0 20px rgba(245, 158, 11, 0.6); }

        .detection-label {
            position: absolute;
            top: -32px;
            left: 0;
            background: rgba(0, 0, 0, 0.9);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            white-space: nowrap;
            animation: labelSlide 0.3s ease-out 0.3s both;
        }

        @keyframes labelSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .camera-controls {
            padding: 1.5rem;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            justify-content: center;
        }

        .analysis-status {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(37, 99, 235, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 1.5rem 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            width: 0%;
            transition: width 0.3s;
        }

        .status-text { color: var(--text-secondary); margin-top: 1rem; }

        .results-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .summary-card {
            background: var(--bg-card);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .summary-card.confidence { border-left: 3px solid var(--primary); }
        .summary-card.issues { border-left: 3px solid var(--danger); }
        .summary-card.cost { border-left: 3px solid var(--warning); }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .summary-value { font-size: 2.25rem; font-weight: 700; line-height: 1; }

        .issues-container {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            margin: 2rem 0;
        }

        .issues-header {
            background: rgba(37, 99, 235, 0.1);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .issue-item { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .issue-item:last-child { border-bottom: none; }

        .issue-header-row {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .issue-title { font-size: 1.125rem; font-weight: 600; margin-bottom: 0.25rem; }
        .issue-location { color: var(--text-secondary); font-size: 0.875rem; }

        .severity-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .severity-high {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .severity-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #fcd34d;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .issue-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        .meta-label { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.25rem; }
        .meta-value { font-weight: 600; }

        .hidden { display: none !important; }
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    backdrop-filter: blur(4px);
}

.modal-content {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: modalAppear 0.3s ease-out;
}

@keyframes modalAppear {
    from { opacity: 0; transform: scale(0.9) translateY(-20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    font-size: 1.5rem;
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 2rem;
    cursor: pointer;
    line-height: 1;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: rgba(255, 255, 255, 0.1);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group:last-child {
    margin-bottom: 0;
}

.form-group label {
    display: block;
    color: var(--text-secondary);
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input {
    width: 100%;
    background: var(--bg-dark);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
    color: var(--text-primary);
    font-size: 1rem;
    font-family: inherit;
    transition: all 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

.form-input::placeholder {
    color: var(--text-secondary);
    opacity: 0.5;
}

textarea.form-input {
    resize: vertical;
    min-height: 80px;
}
.menu-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s;
}

.menu-btn:hover {
    background: rgba(255, 255, 255, 0.1);
}

.menu-btn svg {
    width: 28px;
    height: 28px;
    stroke: var(--text-primary);
    stroke-width: 2.5;
}

.side-menu {
    position: fixed;
    top: 0;
    left: -300px;
    width: 300px;
    height: 100%;
    background: var(--bg-dark);
    box-shadow: 4px 0 15px rgba(0,0,0,0.3);
    z-index: 1001;
    transition: left 0.3s ease;
    display: flex;
    flex-direction: column;
}

.side-menu.open {
    left: 0;
}

.menu-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
}

.menu-header h2 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
}

.menu-header p {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.menu-nav {
    flex-grow: 1;
    list-style: none;
    padding: 1rem 0;
}

.menu-nav a {
    display: block;
    color: var(--text-primary);
    text-decoration: none;
    padding: 1rem 1.5rem;
    font-size: 1rem;
    font-weight: 500;
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

.menu-nav a:hover, .menu-nav a.active {
    background: rgba(37, 99, 235, 0.1);
    border-left-color: var(--primary);
    color: var(--primary);
}

.menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease;
}

.menu-overlay.open {
    opacity: 1;
    visibility: visible;
}


        @media (max-width: 768px) {
            .stats-grid, .sample-grid, .results-summary { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
            <h2>StructureScan AI</h2>
            <p>Menu</p>
        </div>
        <nav class="menu-nav">
            <a href="#" onclick="showDashboardView()">Dashboard</a>
            <a href="#" onclick="showProjectsView()">Projects</a>
            <a href="#" onclick="showSettingsView()">Settings</a>
        </nav>
    </div>
    <div id="menuOverlay" class="menu-overlay" onclick="toggleMenu()"></div>

    <div class="header">
        <button class="menu-btn" onclick="toggleMenu()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <div class="header-content">
            <h1>StructureScan AI</h1>
        </div>
        <div style="width: 44px;"></div> <!-- Spacer -->
    </div>

    <div class="container">
        <!-- Dashboard -->
        <div id="dashboardView">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Scans</div>
                    <div class="stat-value">47</div>
                    <div class="stat-trend">↑ 12% this month</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Issues Detected</div>
                    <div class="stat-value">12</div>
                    <div class="stat-trend">3 high priority</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Est. Savings</div>
                    <div class="stat-value">$8.4K</div>
                    <div class="stat-trend">Early detection value</div>
                </div>
            </div>

            <div class="action-card" onclick="openProjectModal()">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 20px; margin: 0 auto 1.5rem; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 40px; height: 40px; stroke: white; stroke-width: 2; fill: none;" viewBox="0 0 24 24">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </div>
                <h2>Start Structural Analysis</h2>
                <p>Capture images to detect structural issues, water damage, and estimate repair costs using AI-powered analysis.</p>
                <button class="btn-primary" style="margin-top: 1.5rem;">Begin Scan</button>
            </div>
        </div>

        <!-- Sample Selection -->
        <div id="sampleView" class="hidden">
            <button class="btn-secondary" onclick="showDashboard()">← Back</button>
            <h2 style="margin: 2rem 0 1rem; font-size: 1.75rem;">Select Sample to Analyze</h2>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">Choose a structural issue to see AI detection in action</p>
            
            <div class="sample-grid">
                <div class="sample-card" onclick="selectSample('water')">
                    <img src='https://i.imgur.com/sVkNhey.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Water Damage">
                    <div class="sample-info">
                        <div class="sample-title">Water Damage - Wall</div>
                        <div class="sample-desc">Visible water staining with potential mold growth</div>
                    </div>
                </div>
                <div class="sample-card" onclick="selectSample('crack')">
                    <img src='https://i.imgur.com/AnkAyMC.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Wall Crack">
                    <div class="sample-info">
                        <div class="sample-title">Structural Crack - Wall</div>
                        <div class="sample-desc">Vertical crack indicating settlement issues</div>
                    </div>
                </div>
                <div class="sample-card" onclick="selectSample('corrosion')">
                    <img src='https://i.imgur.com/6jrvabV.jpg'w=400&h=300&fit=crop" class="sample-image" alt="Pipe Corrosion">
                    <div class="sample-info">
                        <div class="sample-title">Pipe Corrosion</div>
                        <div class="sample-desc">Metal corrosion on exposed plumbing</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Camera/Analysis -->
        <div id="cameraView" class="hidden">
            <button class="btn-secondary" onclick="showSamples()">← Back</button>
            
            <div class="camera-view">
                <img id="previewImage" class="camera-preview" alt="Preview">
                <div class="camera-overlay" id="detectionOverlay"></div>
                <div class="camera-controls">
                    <button class="btn-primary" id="analyzeBtn" onclick="runAnalysis()">Analyze Image</button>
                </div>
            </div>

            <div id="analysisStatus" class="analysis-status hidden">
                <h3>AI Analysis in Progress</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="status-text" id="statusText">Initializing detection algorithms...</div>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsView" class="hidden">
            <button class="btn-secondary" onclick="showDashboard()">← Start New Scan</button>
            
            <h2 style="font-size: 2rem; margin: 2rem 0 0.5rem;">Analysis Complete</h2>
            <p style="color: var(--text-secondary); margin-bottom: 2rem;">Scan completed • <span id="timestamp"></span></p>

            <div class="camera-view">
                <img id="resultImage" class="camera-preview" alt="Result">
                <div class="camera-overlay" id="resultOverlay"></div>
            </div>

            <div class="results-summary">
                <div class="summary-card confidence">
                    <div class="summary-label">AI Confidence</div>
                    <div class="summary-value" style="color: var(--primary);" id="confidenceValue">91%</div>
                </div>
                <div class="summary-card issues">
                    <div class="summary-label">Issues Found</div>
                    <div class="summary-value" style="color: var(--danger);" id="issuesCount">1</div>
                </div>
                <div class="summary-card cost">
                    <div class="summary-label">Est. Repair Cost</div>
                    <div class="summary-value" style="color: var(--warning); font-size: 1.75rem;" id="costValue">$2.4K-3.8K</div>
                </div>
            </div>

            <div class="issues-container">
                <div class="issues-header">
                    <h3>Detected Issues</h3>
                </div>
                <div id="issuesList"></div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 2rem;">
                <button class="btn-primary" onclick="exportPDF()">Export Full Report</button>
                <button class="btn-primary">Schedule Repairs</button>
            </div>
        </div>

        <!-- Projects View -->
        <div id="projectsView" class="hidden">
            <h2 style="font-size: 2rem; margin-bottom: 1rem;">Projects</h2>
            <div id="projectList" class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                 <!-- Projects will be dynamically inserted here -->
                <div class="stat-card" style="cursor: pointer;" onclick="alert('Navigate to project details')">
                    <div class="stat-label">123 Main Street</div>
                    <div class="stat-value" style="font-size: 1.5rem;">3 Scans</div>
                    <div class="stat-trend">Last scan: 11/08/2025</div>
                </div>
                 <div class="stat-card" style="cursor: pointer;" onclick="alert('Navigate to project details')">
                    <div class="stat-label">Downtown Pipe Inspection</div>
                    <div class="stat-value" style="font-size: 1.5rem;">1 Scan</div>
                    <div class="stat-trend">Last scan: 11/05/2025</div>
                </div>
                <div class="action-card" onclick="openProjectModal()">
                     <h3 style="margin-bottom: 1rem;">Create New Project</h3>
                    <p>Start a new scan and save it as a new project.</p>
                </div>
            </div>
        </div>

        <!-- Settings View -->
        <div id="settingsView" class="hidden">
            <h2 style="font-size: 2rem; margin-bottom: 2rem;">Settings</h2>
            <div class="form-group">
                <label>Company Name</label>
                <input type="text" id="companyName" placeholder="e.g., Restoration Experts Inc" class="form-input">
            </div>
            <div class="form-group">
                <label>Company Address</label>
                <input type="text" id="companyAddress" placeholder="e.g., 123 Main St, Fort Wayne, IN" class="form-input">
            </div>
            <div class="form-group">
                <label>Contact Info</label>
                <input type="text" id="contactInfo" placeholder="e.g., John Smith (555) 123-4567" class="form-input">
            </div>
            <button class="btn-primary" onclick="saveSettings()" style="margin-right: 1rem;">Save Settings</button>
            <button class="btn-secondary" onclick="requestNotificationPermission()">Enable Notifications</button>
        </div>

        <!-- Project Detail View -->
        <div id="projectDetailView" class="hidden">
            <button class="btn-secondary" onclick="showProjectsView()">← Back to Projects</button>
            <div id="projectDetailHeader" style="margin: 2rem 0;">
                <!-- Project details will be injected here -->
            </div>
            <div id="projectScansList" class="sample-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
                <!-- Scans will be injected here -->
            </div>
        </div>
    </div>
<!-- Project Setup Modal -->
<div id="projectModal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Scan</h2>
            <button class="modal-close" onclick="closeProjectModal()">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" placeholder="e.g., 123 Main Street Inspection" class="form-input">
            </div>
            <div class="form-group">
                <label for="propertyAddress">Property Address (Optional)</label>
                <input type="text" id="propertyAddress" placeholder="e.g., 123 Main St, Fort Wayne, IN" class="form-input">
            </div>
            <div class="form-group">
                <label for="clientName">Client Name (Optional)</label>
                <input type="text" id="clientName" placeholder="e.g., John Smith" class="form-input">
            </div>
            <div class="form-group">
                <label for="scanNotes">Notes (Optional)</label>
                <textarea id="scanNotes" placeholder="Add any relevant notes..." class="form-input" rows="3"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="closeProjectModal()">Cancel</button>
            <button class="btn-primary" onclick="saveProjectAndContinue()">Continue to Scan</button>
        </div>
    </div>
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const samples = {
            water: {
                image: 'https://i.imgur.com/sVkNhey.jpg',
                confidence: 94,
                issue: {
                    type: 'Water Damage & Mold Growth',
                    location: 'Baseboard - Lower Wall Section',
                    severity: 'high',
                    desc: 'Active water intrusion with visible mold growth and paint deterioration. Dark staining indicates prolonged moisture exposure. Immediate remediation required to prevent health hazards and structural damage.',
                    confidence: 94,
                    cost: '$2,400-$3,800',
                    urgency: '7-14 days',
                    box: { top: '40%', left: '20%', width: '35%', height: '30%' }
                }
            },
            corrosion: {
                image: 'https://i.imgur.com/6jrvabV.jpg',
                confidence: 96,
                issue: {
                    type: 'Severe Pipe Corrosion',
                    location: 'Exposed Plumbing Lines - Basement',
                    severity: 'high',
                    desc: 'Advanced corrosion with heavy rust buildup and material degradation. Multiple connection points compromised. Critical failure risk - pipe replacement urgent to prevent catastrophic water damage and flooding.',
                    confidence: 96,
                    cost: '$1,800-$3,200',
                    urgency: '7-21 days',
                    box: { top: '35%', left: '30%', width: '40%', height: '35%' }
                }
            },
            crack: {
                image: 'https://i.imgur.com/AnkAyMC.jpg',
                confidence: 89,
                issue: {
                    type: 'Structural Crack Pattern',
                    location: 'Interior Wall - Main Structure',
                    severity: 'medium',
                    desc: 'Multiple stress cracks detected across wall surface. Pattern indicates structural settlement or foundation movement. Significant cracking visible throughout. Monitoring and repair recommended to prevent progression.',
                    confidence: 89,
                    cost: '$1,200-$2,400',
                    urgency: '30-60 days',
                    box: { top: '15%', left: '20%', width: '60%', height: '70%' }
                }
            }
        };

        let currentSample = null;
        let currentProject = null;

        const allViews = ['dashboardView', 'sampleView', 'cameraView', 'resultsView', 'projectsView', 'settingsView', 'projectDetailView'];

        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('open');
            document.getElementById('menuOverlay').classList.toggle('open');
        }

        function showView(viewId) {
            allViews.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            // Always close the menu when showing a new view.
            document.getElementById('sideMenu').classList.remove('open');
            document.getElementById('menuOverlay').classList.remove('open');
        }

        function showDashboardView() { showView('dashboardView'); }
        function showProjectsView() {
            renderProjectList();
            showView('projectsView');
        }
        function showSettingsView() { showView('settingsView'); }

        function showDashboard() {
            allViews.forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('dashboardView').classList.remove('hidden');
        }

        // --- LocalStorage Project Management ---
        function getProjects() {
            return JSON.parse(localStorage.getItem('struc_projects') || '[]');
        }

        function saveProjects(projects) {
            localStorage.setItem('struc_projects', JSON.stringify(projects));
        }

        function saveScanToProject(projectId, scanData) {
            const projects = getProjects();
            const project = projects.find(p => p.id === projectId);
            if (project) {
                if (!project.scans) {
                    project.scans = [];
                }
                project.scans.push(scanData);
                saveProjects(projects);
            }
        }

       function openProjectModal() {
    document.getElementById('projectModal').classList.remove('hidden');
}

function closeProjectModal() {
    document.getElementById('projectModal').classList.add('hidden');
    // Clear the form
    document.getElementById('projectName').value = '';
    document.getElementById('propertyAddress').value = '';
    document.getElementById('clientName').value = '';
    document.getElementById('scanNotes').value = '';
}

function saveProjectAndContinue() {
    const projectName = document.getElementById('projectName').value.trim();
    
    if (!projectName) {
        alert('Please enter a project name');
        return;
    }

    const newProject = {
        id: 'proj_' + Date.now(),
        name: projectName,
        address: document.getElementById('propertyAddress').value.trim(),
        client: document.getElementById('clientName').value.trim(),
        notes: document.getElementById('scanNotes').value.trim(),
        createdAt: new Date().toISOString(),
        scans: []
    };
    
    const projects = getProjects();
    projects.push(newProject);
    saveProjects(projects);

    currentProject = newProject;

    closeProjectModal();
    showSamples();
}

function renderProjectList() {
    const projects = getProjects();
    const projectListEl = document.getElementById('projectList');
    projectListEl.innerHTML = ''; // Clear existing list

    if (projects.length === 0) {
        projectListEl.innerHTML = `<div class="action-card" onclick="openProjectModal()">
                                        <h3 style="margin-bottom: 1rem;">No Projects Found</h3>
                                        <p>Start a new scan to create your first project.</p>
                                    </div>`;
        return;
    }

    projects.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

    projects.forEach(project => {
        const lastScanDate = project.scans.length > 0 ? new Date(project.scans[project.scans.length - 1].date).toLocaleDateString() : 'No scans yet';
        const card = `
            <div class="stat-card" style="cursor: pointer;" onclick="viewProject('${project.id}')">
                <div class="stat-label">${project.name}</div>
                <div class="stat-value" style="font-size: 1.5rem;">${project.scans.length} Scans</div>
                <div class="stat-trend">Last scan: ${lastScanDate}</div>
            </div>
        `;
        projectListEl.innerHTML += card;
    });

    // Add the "Create New" card at the end
    projectListEl.innerHTML += `<div class="action-card" onclick="openProjectModal()">
                                     <h3 style="margin-bottom: 1rem;">Create New Project</h3>
                                    <p>Start a new scan and save it as a new project.</p>
                                </div>`;
}

function viewProject(projectId) {
    const projects = getProjects();
    const project = projects.find(p => p.id === projectId);
    if (!project) return;

    currentProject = project; // Set the current project context

    const headerEl = document.getElementById('projectDetailHeader');
    headerEl.innerHTML = `
        <h2 style="font-size: 2rem; margin-bottom: 0.5rem;">${project.name}</h2>
        <p style="color: var(--text-secondary);">${project.address || 'No address provided'}</p>
    `;

    const scansListEl = document.getElementById('projectScansList');
    scansListEl.innerHTML = ''; // Clear previous scans

    if (project.scans && project.scans.length > 0) {
        project.scans.forEach(scan => {
            const scanCard = `
                <div class="sample-card">
                    <img src="${scan.results.image}" class="sample-image" alt="${scan.results.issue.type}">
                    <div class="sample-info">
                        <div class="sample-title">${scan.results.issue.type}</div>
                        <div class="sample-desc">Scanned on ${new Date(scan.date).toLocaleDateString()}</div>
                    </div>
                </div>
            `;
            scansListEl.innerHTML += scanCard;
        });
    }

    // Add "Add New Scan" button
    scansListEl.innerHTML += `
        <div class="action-card" onclick="startNewScanForCurrentProject()">
            <h3 style="margin-bottom: 1rem;">Add New Scan</h3>
            <p>Start a new scan for this project.</p>
        </div>
    `;

    showView('projectDetailView');
}

function startNewScanForCurrentProject() {
    // This function leverages the fact that currentProject is already set
    if (!currentProject) {
        alert("No project selected!");
        return;
    }
    showSamples();
}

        // --- Settings Management ---
        function saveSettings() {
            const settings = {
                companyName: document.getElementById('companyName').value.trim(),
                companyAddress: document.getElementById('companyAddress').value.trim(),
                contactInfo: document.getElementById('contactInfo').value.trim(),
            };
            localStorage.setItem('struc_settings', JSON.stringify(settings));
            alert('Settings saved!');
            showDashboardView();
        }

        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('struc_settings') || '{}');
            document.getElementById('companyName').value = settings.companyName || '';
            document.getElementById('companyAddress').value = settings.companyAddress || '';
            document.getElementById('contactInfo').value = settings.contactInfo || '';
        }

        document.addEventListener('DOMContentLoaded', () => {
    loadSettings();

    // 1. Initialize Lead Tracking & Service Worker Registration
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registered.');
                initializeLeadTracking(); 
                // 2. Start push subscription process immediately after SW registration
                subscribeUserToPush(registration); 
            })
            .catch(error => console.error('Service Worker registration failed:', error));
    } else {
         initializeLeadTracking(); // Run tracking initialization even if SW fails
    }
});

        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                alert('This browser does not support desktop notification');
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    alert('Notifications enabled!');
                    // Here you would typically send the subscription to your server
                } else {
                    alert('Notifications denied.');
                }
            });
        }

        function showSamples() {
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('sampleView').classList.remove('hidden');
            document.getElementById('cameraView').classList.add('hidden');
            document.getElementById('resultsView').classList.add('hidden');
        }

        function selectSample(type) {
            currentSample = samples[type];
            document.getElementById('sampleView').classList.add('hidden');
            document.getElementById('cameraView').classList.remove('hidden');
            document.getElementById('previewImage').src = currentSample.image;
            document.getElementById('detectionOverlay').innerHTML = '';
            document.getElementById('analysisStatus').classList.add('hidden');
            document.getElementById('analyzeBtn').disabled = false;
            window.selectedSampleKey = type;
        }

        // --- Usage Meter and AI Execution Logic (Phase 3.1) ---
// --- Finalized runAnalysis() Function Blueprint (REPLACES ORIGINAL FUNCTION) ---
async function runAnalysis() {
    // PASSES THE GLOBAL TRACKING IDS TO THE METERED FUNCTION
    if (!currentLeadId || !currentExhId) {
        alert("Tracking Error: Please launch the app using your unique NFC card or link.");
        return;
    }

    // 1. Show loading UI
    document.getElementById('analyzeBtn').disabled = true;
    document.getElementById('analysisStatus').classList.remove('hidden');

    // 2. Execute Metered Analysis (calls the secure API endpoint blueprint)
    const analysisResult = await executeMeteredAnalysis(currentLeadId, currentExhId); 

    // 3. Handle Results
    if (analysisResult.success) {
        // Update UI with the real data returned by the server
        currentSample = analysisResult.data; 
        
        // Simulate progress animation visually before showing results
        await animateProgressBar(); 
        
        showResults();
        
    } else if (analysisResult.message === 'USAGE_CAP_REACHED') {
        alert("Scan failed: You have reached your pre-paid scan limit. Please contact the exhibitor for a renewal token.");
        document.getElementById('analysisStatus').classList.add('hidden');
        document.getElementById('analyzeBtn').disabled = false;
    } else {
        alert(`Analysis failed: ${analysisResult.message}`);
        document.getElementById('analysisStatus').classList.add('hidden');
        document.getElementById('analyzeBtn').disabled = false;
    }
}


// --- Function executed by runAnalysis() to communicate with the Backend Engine (Endpoint A Blueprint) ---
async function executeMeteredAnalysis(leadId, exhId) {
    
    if (!leadId || !exhId) {
        return { success: false, message: 'TRACKING_MISSING' };
    }

    // 1. Prepare Data Payload
    const payload = {
        leadId: leadId,
        exhId: exhId,
        imageData: captureImageAsBase64(), 
        prompt: "Analyze the image for structural damage (corrosion, crack, water). Provide severity, estimated cost range, and certainty score for the report." 
    };

    try {
        // 2. Execute Secure API Call (to Endpoint A: /api/v1/scan)
        const response = await fetch(`${BACKEND_URL}/api/v1/scan`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        // 3. Handle Network Errors
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        // 4. Handle Business Logic Errors
        if (result.error) {
            if (result.code === 'USAGE_CAP_REACHED') {
                return { success: false, message: 'USAGE_CAP_REACHED' };
            }
            return { success: false, message: result.message };
        }
        
        // 5. Success: Return the final analysis data
        return { 
            success: true, 
            data: result.analysisData,
            scansRemaining: result.scansRemaining 
        };

    } catch (e) {
        console.error("Scan API Failure:", e);
        return { success: false, message: "A network error occurred. Please check connectivity." };
    }
}


// --- NOTE: The existing animateProgressBar() function should be KEPT as is. ---
// --- NOTE: The existing showDetectionBox() and showResults() should be KEPT as is. ---
// --- NEW: Global variable for testing the cap ---
let mockScansRemaining = 25; // STARTING CAP FOR TESTING (Adjust this number: 20-30)

// --- REVISED Metered Analysis Function (Picks the Selected Sample) ---
async function executeMeteredAnalysis(leadId) {
    console.log(`[Server Sim] Requesting metered analysis for ${leadId}...`);
    
    // --- 1. SIMULATED USAGE CHECK (Keep this logic for metering) ---
    if (mockScansRemaining <= 0) { 
         console.log(`[Server Sim] Usage cap reached for ${leadId}. Scans remaining: 0`);
         return { success: false, message: 'USAGE_CAP_REACHED' };
    }
    
    // --- 2. SIMULATED DEDUCTION ---
    mockScansRemaining -= 1; 
    console.log(`[Server Sim] Scan successful. New scans remaining: ${mockScansRemaining}`);

    // --- 3. EXECUTE AI AND RETURN PAYLOAD (FIXED LOGIC) ---
    await new Promise(r => setTimeout(r, 1000));
    
    // Check which sample key was selected globally
    const selectedKey = window.selectedSampleKey;
    
    // *** CRITICAL CHANGE: Return the exact sample data selected by the user ***
    return { 
        success: true, 
        scansRemaining: mockScansRemaining,
        data: samples[selectedKey] // <-- Now returns the selected, non-random data
    };
}
// --- NEW: Visual progress animation function ---
function animateProgressBar() {
    document.getElementById('progressBar').style.width = '0%';
    let progress = 0;
    let statusIndex = 0;
    const statuses = [
        'Initializing AI detection...', 'Analyzing image structure...', 
        'Detecting anomalies...', 'Measuring damage severity...', 
        'Calculating repair costs...', 'Finalizing analysis...'
    ];

    return new Promise(resolve => {
        const interval = setInterval(() => {
            progress += 5; // Animate faster
            document.getElementById('progressBar').style.width = progress + '%';

            if (progress % 17 < 5 && statusIndex < statuses.length) {
                document.getElementById('statusText').textContent = statuses[statusIndex];
                statusIndex++;
            }

            if (progress >= 100) {
                clearInterval(interval);
                resolve();
            }
        }, 60);
    });
}

        function showDetectionBox() {
            const overlay = document.getElementById('detectionOverlay');
            const issue = currentSample.issue;
            
            const box = document.createElement('div');
            box.className = `detection-box ${issue.severity}`;
            box.style.top = issue.box.top;
            box.style.left = issue.box.left;
            box.style.width = issue.box.width;
            box.style.height = issue.box.height;
            
            const label = document.createElement('div');
            label.className = 'detection-label';
            label.textContent = issue.type + ' Detected';
            label.style.color = issue.severity === 'high' ? '#fca5a5' : '#fcd34d';
            box.appendChild(label);
            
            overlay.appendChild(box);
        }

        function showResults() {
            document.getElementById('cameraView').classList.add('hidden');
            document.getElementById('resultsView').classList.remove('hidden');
            
            const issue = currentSample.issue;
            const scanDate = new Date();
            
            document.getElementById('timestamp').textContent = scanDate.toLocaleString();
// Add project info to results if exists
if (currentProject.name) {
    const projectInfo = `
        <div style="background: var(--bg-card); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border-left: 3px solid var(--primary);">
            <div style="font-weight: 600; margin-bottom: 0.5rem;">Project: ${currentProject.name}</div>
            ${currentProject.address ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">Address: ${currentProject.address}</div>` : ''}
            ${currentProject.client ? `<div style="font-size: 0.875rem; color: var(--text-secondary);">Client: ${currentProject.client}</div>` : ''}
        </div>
    `;
    document.querySelector('#resultsView h2').insertAdjacentHTML('afterend', projectInfo);

    const scanData = {
        id: 'scan_' + Date.now(),
        date: scanDate.toISOString(),
        sampleType: Object.keys(samples).find(key => samples[key] === currentSample),
        results: currentSample
    };
    saveScanToProject(currentProject.id, scanData);
}
            document.getElementById('resultImage').src = currentSample.image;
            document.getElementById('confidenceValue').textContent = currentSample.confidence + '%';
            document.getElementById('issuesCount').textContent = '1';
            document.getElementById('costValue').textContent = issue.cost;
            
            const resultOverlay = document.getElementById('resultOverlay');
            resultOverlay.innerHTML = '';
            const box = document.createElement('div');
            box.className = `detection-box ${issue.severity}`;
            box.style.top = issue.box.top;
            box.style.left = issue.box.left;
            box.style.width = issue.box.width;
            box.style.height = issue.box.height;
            resultOverlay.appendChild(box);
            
            document.getElementById('issuesList').innerHTML = `
                <div class="issue-item">
                    <div class="issue-header-row">
                        <div>
                            <div class="issue-title">${issue.type}</div>
                            <div class="issue-location">${issue.location}</div>
                        </div>
                        <div class="severity-badge severity-${issue.severity}">${issue.severity.toUpperCase()}</div>
                    </div>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">${issue.desc}</p>
                    <div class="issue-meta">
                        <div>
                            <div class="meta-label">AI Confidence</div>
                            <div class="meta-value">${issue.confidence}%</div>
                        </div>
                        <div>
                            <div class="meta-label">Est. Cost</div>
                            <div class="meta-value">${issue.cost}</div>
                        </div>
                        <div>
                            <div class="meta-label">Urgency</div>
                            <div class="meta-value" style="color: ${issue.severity === 'high' ? 'var(--danger)' : 'var(--warning)'};">${issue.urgency}</div>
                        </div>
                    </div>
                </div>
            `;
            
            window.scrollTo(0, 0);
        }
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const issue = currentSample.issue;
    const pw = doc.internal.pageSize.getWidth();
    const ph = doc.internal.pageSize.getHeight();
    const m = 20;
    const cw = pw - (m * 2);
    
    // Blue header background
    doc.setFillColor(37, 99, 235);
    doc.rect(0, 0, pw, 45, 'F');
    
    // Company branding
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(24);
    doc.setFont(undefined, 'bold');
    doc.text('StructureScan AI', m, 20);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text('Professional Structural Analysis Report', m, 28);
    doc.text('Powered by Restoration Experts Inc', m, 34);
    
    // Metadata box
    doc.setTextColor(0, 0, 0);
    doc.setFillColor(248, 250, 252);
    doc.roundedRect(m, 55, cw, 25, 2, 2, 'F');
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'bold');
    doc.text('Report Date:', m + 5, 63);
    doc.text('Analysis ID:', m + 5, 70);
    doc.text('Confidence:', m + 5, 77);
    
    doc.setFont(undefined, 'normal');
    const ts = new Date().toLocaleString();
    doc.text(ts, m + 30, 63);
    doc.text('SSA-' + Math.random().toString(36).substr(2, 9).toUpperCase(), m + 30, 70);
    doc.text(currentSample.confidence + '%', m + 30, 77);
    
    // Executive Summary
    let y = 90;
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(37, 99, 235);
    doc.text('Executive Summary', m, y);
    
    y += 10;
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    
    const sum = 'AI-powered structural analysis has identified critical issues requiring immediate attention. This report provides detailed findings, severity assessment, and recommended actions based on advanced computer vision algorithms.';
    const sumLines = doc.splitTextToSize(sum, cw);
    doc.text(sumLines, m, y);
    y += sumLines.length * 5 + 10;
    
    // Critical Finding Alert Box
    doc.setFillColor(254, 226, 226);
    doc.setDrawColor(239, 68, 68);
    doc.setLineWidth(0.5);
    doc.roundedRect(m, y, cw, 40, 2, 2, 'FD');
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(220, 38, 38);
    doc.text('⚠ Critical Finding', m + 5, y + 8);
    
    doc.setFontSize(11);
    doc.setTextColor(0, 0, 0);
    doc.text(issue.type, m + 5, y + 16);
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    doc.text('Location: ' + issue.location, m + 5, y + 23);
    doc.text('Severity: ' + issue.severity.toUpperCase(), m + 5, y + 29);
    doc.text('Estimated Cost: ' + issue.cost, m + 5, y + 35);
    
    y += 50;
    
// Analysis Image Section
doc.setFontSize(14);
doc.setFont(undefined, 'bold');
doc.setTextColor(37, 99, 235);
doc.text('Analysis Image', m, y);
y += 5;

// Add the image directly from URL with CORS proxy
try {
    const imgSrc = currentSample.image;
    doc.addImage(imgSrc, 'JPEG', m, y, cw, 80, undefined, 'FAST');
    y += 90;
} catch (error) {
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Image URL: ' + currentSample.image, m, y);
    y += 10;
}
    
    // Check if we need a new page
    if (y > ph - 80) {
        doc.addPage();
        y = 20;
    }
    
    // Detailed Analysis
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(37, 99, 235);
    doc.text('Detailed Analysis', m, y);
    y += 8;
    
    doc.setFontSize(10);
    doc.setTextColor(0, 0, 0);
    doc.setFont(undefined, 'normal');
    const detailLines = doc.splitTextToSize(issue.desc, cw);
    doc.text(detailLines, m, y);
    y += detailLines.length * 5 + 10;
    
    // Recommendations Section
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(37, 99, 235);
    doc.text('Recommendations', m, y);
    y += 8;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);
    
    const recs = [
        '• Immediate professional inspection by certified structural engineer',
        '• Document all findings with additional photography',
        '• Obtain repair quotes from licensed contractors',
        '• Address within recommended urgency timeframe: ' + issue.urgency,
        '• Monitor for progression until repairs are completed'
    ];
    
    recs.forEach(rec => {
        if (y > ph - 20) {
            doc.addPage();
            y = 20;
        }
        doc.text(rec, m, y);
        y += 7;
    });
    
    // Footer disclaimer
    const footerY = ph - 25;
    doc.setFontSize(8);
    doc.setTextColor(100, 100, 100);
    doc.setFont(undefined, 'italic');
    const disclaimer = 'This report is generated by AI-assisted analysis and should be verified by qualified professionals. Restoration Experts Inc provides this analysis as a preliminary assessment tool.';
    const disclaimerLines = doc.splitTextToSize(disclaimer, cw);
    doc.text(disclaimerLines, m, footerY);
    
    doc.setDrawColor(200, 200, 200);
    doc.line(m, footerY - 5, pw - m, footerY - 5);
    
    // Page numbers
    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('Page ' + i + ' of ' + pageCount, pw - m - 20, ph - 10);
    }
    
    // Save the PDF
    const filename = 'StructureScan_Report_' + new Date().toISOString().slice(0,10) + '.pdf';
    doc.save(filename);
}
        // =======================================================
// === AFFEIOIQ LEAD TRACKING AND PUSH SYSTEM INTEGRATION ===
// =======================================================

// 1. Global Tracking Variables and Constants
let currentLeadId = null;
let currentExhId = null;
const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE'; // *** CRITICAL: REPLACE WITH YOUR REAL KEY ***
// Define your secure backend URL once here:
const BACKEND_URL = 'YOUR_SECURE_BACKEND_URL'; // *** CRITICAL: REPLACE WITH YOUR SERVER URL WHEN DEPLOYED ***


// --- NEW Helper Function (Required by executeMeteredAnalysis) ---
function captureImageAsBase64() {
    // For the prototype, we simulate sending the data by returning the image URL of the selected sample.
    if (currentSample && currentSample.image) {
        return currentSample.image; 
    }
    return null; 
}
// ---------------------------------------------------------
// Utility Function to get URL Parameters (Phase 1.3)
function getUrlParameter(name) {
    name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
    const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
    const results = regex.exec(location.search);
    return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
}

// =======================================================
        // 2. Simulated/Required Server Functions
// These functions simulate secure communication with your central database/API.

// 2a. Notifies the server of a new lead activation (updates status in database)
async function notifyServerOfFirstActivation(leadId, exhId) {
    console.log(`[Server Sim] Lead ${leadId} activated for ${exhId}. Pushing initial data to database...`);
    // *** INTEGRATION POINT: Replace with real secure fetch() call to your backend API ***
}

// 2b. Sends the push token back to the server (updates the 'pushToken' field in Lead Document)
async function sendSubscriptionToServer(subscription) {
    if (!currentLeadId) return;

    const subscriptionData = JSON.stringify(subscription);
    console.log(`[Server Sim] Saving Push Token for Lead ${currentLeadId}: ${subscriptionData.slice(0, 30)}...`);
    // *** INTEGRATION POINT: Replace with real secure fetch() call to update the database ***
}

// 3. Push Enrollment Logic (Phase 3.2)
async function subscribeUserToPush(registration) {
    if (!('PushManager' in window)) return;
    
    // Check if permission is already granted/denied locally before subscribing
    if (Notification.permission === 'granted') {
        try {
            const subscription = await registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: VAPID_PUBLIC_KEY 
            });

            console.log('User is subscribed.');
            await sendSubscriptionToServer(subscription);

        } catch (error) {
            console.warn('Push subscription failed:', error);
        }
    } else {
         console.warn('Push permission not granted locally.');
    }
}

// 4. CORE FUNCTION: Initializes Tracking (Phase 1.3)
function initializeLeadTracking() {
    const urlLeadId = getUrlParameter('leadId');
    const urlExhId = getUrlParameter('exhId');
    const storedLeadId = localStorage.getItem('afferio_leadId');
    const storedExhId = localStorage.getItem('afferio_exhId');

    if (urlLeadId && urlExhId) {
        // FIRST ACTIVATION (via NFC/QR Code): Save and notify server
        currentLeadId = urlLeadId;
        currentExhId = urlExhId;
        localStorage.setItem('afferio_leadId', currentLeadId);
        localStorage.setItem('afferio_exhId', currentExhId);
        console.log(`[AfferioIQ] New Session Started. Lead ID: ${currentLeadId}`);
        notifyServerOfFirstActivation(currentLeadId, currentExhId);

    } else if (storedLeadId && storedExhId) {
        // RETURN USER (Loaded directly from home screen icon)
        currentLeadId = storedLeadId;
        currentExhId = storedExhId;
        console.log(`[AfferioIQ] Returning User Session. Lead ID: ${currentLeadId}`);
        
    } else {
        // ERROR/MISSING ID (User visited URL without parameters or storage cleared)
        console.warn("[AfferioIQ] Tracking Failed: No Lead ID found. Functionality limited.");
    }
}
    </script>
</body>
</html>
